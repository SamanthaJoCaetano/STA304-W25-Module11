---
title: "Causal Inference"
author: "Samantha-Jo Caetano"
date: "April 1, 2025"
output: pdf_document
---


## Propensity Score Matching

### Looking at the data

This is the starting point of the analysis. Let's take a glimpse at the simulated data

```{r}
library(tidyverse)
amazon_purchase_data <- read_csv("Amazon.csv") 
  
  
head(amazon_purchase_data)
glimpse(amazon_purchase_data)
```
 
We are interested in looking at the relationship between "free shipping" and "spending amount".

So free-shipping is our treatment and average spending is our outcome of interest.

Propensity score matching will be for the free-shipping propensity.

Now we construct a logistic regression model that 'explains' whether a person was treated as a function of the variables that we think explain it.

```{r}
propensity_score <- glm(free_shipping ~ age + city + gender + income, 
                        family = binomial,
                        data = amazon_purchase_data)
```

We will now add our forecast to our dataset.

```{r}
amazon_purchase_data <- 
  amazon_purchase_data %>% 
  mutate(
    prob_of_trt = predict(propensity_score, type="response")
  ) 
```

Now we use our forecast to create matches.For every person who was actually treated (given free shipping) we want the untreated person who was considered as similar to them (based on propensity score) as possible.

```{r}
amazon_purchase_data <- 
  amazon_purchase_data %>% 
  arrange(prob_of_trt, free_shipping)
```

Here we're going to use a matching function from the arm package. This finds which is the closest of the ones that were not treated, to each one that was treated.

```{r}
amazon_purchase_data$treated <- 
  if_else(amazon_purchase_data$free_shipping == 0, 0, 1)

# Create a new variable called "treat" which is a 0 or 1.
amazon_purchase_data$treated <- 
  as.integer(amazon_purchase_data$treated)



matches <- arm::matching(z = amazon_purchase_data$treated, 
                         score = amazon_purchase_data$prob_of_trt)

  # the function returns:                 
  # 1) match.ind: a vector of indices that the corresponding unit is  
  #    matched to.   
  # 2) cnts:  shows the number of times each unit will be used in any 
  #    subsequent analyses (1 for each treated unit and number of     
  #    times used as a match for each control unit (equivalently the  
  #    number of treated units it is matched to)                      
  # 3) pairs:  id for the matched matched pair 

amazon_purchase_data <- cbind(amazon_purchase_data, matches)
```

### Reduced/Matched Data

Now we reduce the dataset to just those that are matched. We had 371 treated, so we expect a dataset of 742 observations.

```{r}
amazon_purchase_data_matched <- 
  amazon_purchase_data %>% 
  filter(match.ind != 0) %>% 
  select(-match.ind, -pairs, -treated, -cnts, -prob_of_trt)

head(amazon_purchase_data_matched)
```


Examining the 'effect' of being treated on average spend in the 'usual' way.

```{r}
propensity_score_regression <- 
  lm(average_spend ~ free_shipping, 
                data = amazon_purchase_data_matched)

summary(propensity_score_regression)
```

